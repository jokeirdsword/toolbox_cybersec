import subprocess
import requests

def is_url_alive(url):
    try:
        r = requests.get(url, timeout=5)
        return r.status_code < 500
    except:
        return False

def run_gobuster_scan(target_url, wordlist="wordlist/common.txt"):
    try:
        if not target_url.startswith("http"):
            target_url = "http://" + target_url

        if not is_url_alive(target_url):
            return {"error": "La cible ne répond pas (HTTP). Vérifiez l'adresse et le réseau."}

        cmd = [
            "gobuster", "dir",
            "-u", target_url,
            "-w", wordlist,
            "-q",  # silencieux
            "-t", "50",
            "--timeout", "10s"
        ]

        result = subprocess.run(cmd, capture_output=True, text=True, timeout=180)

        if result.returncode != 0 and not result.stdout.strip():
            return {"error": f"Gobuster a échoué : {result.stderr}"}

        return {"result": result.stdout if result.stdout.strip() else "Aucun répertoire trouvé."}

    except subprocess.TimeoutExpired:
        return {"error": "Gobuster a mis trop de temps à répondre (timeout global)."}
    except Exception as e:
        return {"error": f"Erreur Gobuster: {str(e)}"}


