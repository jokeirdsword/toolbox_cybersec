import subprocess

def metasploit_scan(target):
    try:
        command = f'''
use auxiliary/scanner/portscan/tcp
set RHOSTS {target}
set THREADS 20
set PORTS 1-1000
run
exit
'''
        result = subprocess.run(
            ['msfconsole', '-q', '-x', command],
            capture_output=True,
            text=True,
            timeout=180  # Limite le scan à 3 minutes max
        )
        return {"result": result.stdout}
    
    except subprocess.TimeoutExpired:
        return {"error": "Metasploit a mis trop de temps à répondre (timeout après 3 minutes)."}
    
    except Exception as e:
        return {"error": str(e)}

